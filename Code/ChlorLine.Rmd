---
title: "ChlorLine"
output: html_notebook
---

# Introduction

This .rmd reads chlorophyll data and generates a line graph ...

# Install packages if needed

```{r install_packages}
#install.packages("tidyverse")
#install.packages("kableExtra")
```

# Loading Packages

```{r load packages}
library(tidyverse) 
library(kableExtra)
library(broom)
```
# Reading file

```{r read_vert_migration}
vert_migration <- readRDS( file = file.path("..","Data","CleanData","vert_migration.rds"))
```

# Plotting Chlorophyll concentration over time at different temperatures 

```{r chlor_time}
vert_migration |>
  ggplot() +
  geom_point(aes(x = ToD, y = Chl_ugcm2), alpha = 0.4) +  
  facet_grid(rows = vars(Top_Bottom), cols = vars(Temp_C)) + 
  labs(
    x = "Time of Day", 
    y = expression("Chlorophyll Concentration ("*mu*"g / cm"^2*")"),  
    title = "Chlorophyll Concentrations Across Temperatures", 
    subtitle = "Analyzing chlorophyll concentration at hight tide in the Bay of Fundy at 15°C, 20°C, and 23°C", 
    
  ) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), # Rotate x-axis labels for readability
    panel.background = element_rect(fill = "gray90"),  
    panel.grid.major = element_line(color = "white"), 
    panel.grid.minor = element_blank(),  
    strip.background = element_rect(fill = "lightgray"), 
    strip.text = element_text(face = "bold") 
  )

```
In this plot, it is observed that the bottom layers of the lens paper usually has higher chlorophyll abundance than the top layer. This was already hypothesized: fewer diatoms would migrate to the top layer mainly due to size and motility, and more would stay in the bottom layer, since some were already at the surface by the time the lens papers were placed.


# Top and bottom ratio

vert_migration contains variable Top_Bottom, that describes if the sample was measure from the top or the bottom layer of lens paper. To simplify ratio calculation we used 'pivot_wider' in the data to separate Top_Bottom into two separate variables, Top & Bottom; that lowers the number of rows and increases the number of columns.

```{r top_bottom}
vert_migration_wide <- vert_migration |>
  select(-c(Tissue_Area_cm2, VolSol_mL, Fluorescence_Reading, `...19`,  Chl_ugL)) |>
  pivot_wider(id_cols = c(YYYYMMDDHHMM, Replicate, Temp_C, Light, Trial, DateTime, Date, ToD, E_time_h), names_from = Top_Bottom, values_from = Chl_ugcm2, values_fn = mean) |>
  mutate(TopBottomRatio = top/bottom)

#hack solution to cope with ambiguous row labelling by taking 'mean' of rows with multiple values.

```

# Plot ratio of Top Chl_ugcm2 divided by Bottom Chl_ugcm2

```{r Ratio Top to Bottom Chl_ugcm2}
vert_migration_wide |>
  ggplot() +
  geom_point(aes(x = ToD, y = TopBottomRatio), alpha = 0.7) +
  geom_smooth(aes(x = ToD, y = TopBottomRatio), method = "lm", se = TRUE, color = "blue", linetype = "dashed") +
  facet_grid(cols = vars(Temp_C)) +
  labs(
    x = "Time of Day", 
    y = "Top to Bottom Ratio", 
    title = "Ratio of Top Chlorophyll µg·cm^2 To Bottom Chlorophyll µg·cm^2",subtitle = "Analyzing chlorophyll concentration top to bottom ratios at temperatures 15°C, 20°C, and 23°C", 
  ) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    panel.background = element_rect(fill = "gray90"),
    panel.grid.major = element_line(color = "white"),
    panel.grid.minor = element_blank(),
    strip.background = element_rect(fill = "lightgray"),
    strip.text = element_text(face = "bold")
  )
```

No significant trend in all the three temperature settings due to statistical tests (Nested regressions, linear regression and ANOVA) and wide confidence interval observed in the plot.

There is migration happening, however, not at a measurable trend with temperature, since the data has very few points and is very sparse. It is also possible to observe high ratios in the data, however, a simple regression does not show that, unfortunately.

Although not statistically significant, at 15ºC and 20ºC, it is observed that the ratios were always low at the beginning, increasing later on. At 23ºC, there is no observable nor statistical trend on ratio variability, and the ratios were not higher than ~1.3. 

As time went on the range of values increased. But values did not increase/ high values not reached for 23 degrees 
early top to bottom ratios were low and later top to bottoms were high


# Nested Regression

```{r nested regression}
vert_nest <- vert_migration_wide |>
  nest(.by = Temp_C) |>
  mutate(LinearFit = purrr::map(data, ~lm(TopBottomRatio ~ ToD,
                                            data = .x)),
         LinearTidy = purrr::map(LinearFit, tidy),
         LinearParam = purrr::map(LinearFit, glance),
         LinearPredict = purrr::map(LinearFit, augment)
         )


vert_nest |>
unnest(cols = c(LinearTidy)) |>
 select(-c(data, LinearFit, LinearParam, LinearPredict)) |>
  select(-c(statistic)) |>
  pivot_wider(id_cols = c(Temp_C), names_from = term, values_from = c(estimate, std.error, p.value)) |>
  kable()
```
We completed a nested regression for each temperature setting to determine if there is any significant slope/trend in our data. And, from the results of the nested regression, there is not a significant trend in any of the temperature settings.

# Linear regression and ANOVA

```{r linear regression}
summary(lm(TopBottomRatio ~ ToD * Temp_C,
           data = vert_migration_wide))

summary(aov(TopBottomRatio ~ ToD * Temp_C,
           data = vert_migration_wide))
```
Both the linear model and the ANOVA suggest that neither ToD nor the interaction between ToD and Temperature significantly affect the TopBottomRatio variable. However, there is a borderline significance for temperature in the ANOVA test, at a p-value of 0.0711, hinting at a possible minor effect of temperature in the TopBottomRatio variable

The R-squared values in the linear model also indicate that the predictors explain very little of the variability in the TopBottomRatio variable.


