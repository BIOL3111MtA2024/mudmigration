---
title: "Mud Migration Community Compositon"
output: html_notebook
---
# Install packages if needed
```{r install_packages}
#install.packages("googlesheets4")
#install.packages("googledrive")
#install.packages("tidyverse")
```

# Load packages
```{r load_packages}
library(googlesheets4)
library(googledrive)
library(tidyverse)
```

# Connect to google account
Deauthorize google account to allow universal access to the raw data sheet.Then retrive data sheet from where it's stored on google drive.
```{r connect_google}
gs4_deauth()
googlesheet_url <- "https://docs.google.com/spreadsheets/d/1Ga0qnVxOVR9NwSNI5RM1iz1L2MoCAyF0O4x3D6mCePw/edit?gid=405129858#gid=405129858"
```

# Accessing sheets
```{r accessing_sheets}
community_composition <- read_sheet(googlesheet_url, sheet = "community_composition")
raw_cell_measurements <- read_sheet(googlesheet_url, sheet = "raw_cell_measurements")
data_dictionary <- read_sheet(googlesheet_url, sheet = "data_dictionary")
```

# Set missing values of width_1 and width_2
```{r missing_widths}
raw_cell_measurements_2 <- raw_cell_measurements |>
  mutate(Width1_um = case_when(
    is.na(Width1_um) ~ 1,
    TRUE ~ Width1_um
  ))

raw_cell_measurements_3 <- raw_cell_measurements_2 |>
  mutate(Width2_um = case_when(is.na(Width2_um) ~ Width1_um,
                               !is.na(Width2_um) ~ Width2_um
  ))
```

# Estimate Volumes & Maximum Linear Dimension
```{r volumes_maxlinear}

#need volume equations for cylinder (Centric), rectangular prism (pennate), oblate spheroid for undefined & peanut?

raw_cell_measurements_4 <- raw_cell_measurements_3 |>
  mutate(CellVol = case_when(CellMorphotype == "centric" ~ pi * (Width1_um/2)^2 *  Width2_um,
                          CellMorphotype == "pennate" ~  Length_um * Width1_um * Width2_um,
                          CellMorphotype == "undefined" ~ 4/3 * pi * (Length_um/2)^3, 
                          CellMorphotype == "peanut" ~   Length_um * Width1_um * Width2_um
  )
  )

raw_cell_measurements_4 <- raw_cell_measurements_4 |>
  rowwise() |>
  mutate(MaxDim_um = max(Length_um, Width1_um, Width2_um, na.rm = TRUE)
  )
```

# Histogram of volumes and max dimension
```{r histogram}
raw_cell_measurements_4 |>
  ggplot()+
  geom_histogram(aes(CellVol))

raw_cell_measurements_4 |>
  ggplot()+
  geom_histogram(aes(MaxDim_um))
```


# Bin max dimension
```{r bin_dimension}
bin_ranges <- c(0, 5, 10, 20, 30, 40, 50, 75, 100, 150, 200)
raw_cell_measurements_4 <- raw_cell_measurements_4 |>
  dplyr::mutate(MaxDim_Bin = cut(MaxDim_um, breaks = bin_ranges, include.lowest = TRUE, labels = c("0-5", "5-10", "10-20", "20-30", "30-40", "40-50", "50-75", "75-100", "100-150", "150-200")))
```

# Merge common value between raw data and conditions
```{r merge_sheets}
merged_data <- merge(community_composition, raw_cell_measurements_4, by = "SamplePhotoID", all.x = TRUE)
```

# Create bargraph to visualize cell counts per sample
```{r bargraph_sample}
# Count occurrences of each value
CellCount <- merged_data %>%
  count(SamplePhotoID)

# Create the bar graph
ggplot(CellCount, aes(x = SamplePhotoID, y = n)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(x = "Sample", y = "Number of Cells", title = "Number of Cells per Sample") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Bargraph using associated data
```{r bargraph_associated}
ggplot(associated_data, aes(x = interaction(Light, Temp_C, Top_Bottom), y = SamplePhotoID, fill = Light)) +
  geom_bar(stat = "identity") +
  labs(x = "Condition (Light, Temp_C, Top_Bottom)", y = "Cell Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(associated_data, aes(x = interaction(Light, Temp_C, Top_Bottom), y = SamplePhotoID, fill = Top_Bottom)) +
  geom_bar(stat = "identity") +
  labs(x = "Condition (Light, Temp_C, Top_Bottom)", y = "Cell Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(associated_data, aes(x = interaction(Light, Temp_C, Top_Bottom), y = SamplePhotoID, fill = Temp_C)) +
  geom_bar(stat = "identity") +
  labs(x = "Condition (Light, Temp_C, Top_Bottom)", y = "Cell Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# ANOVA on the number of cells observed under each experimental condition
```{r anova}
count_data <- merged_data %>%
  group_by(Temp_C, Light, Top_Bottom) %>%
  summarise(SamplePhotoID = n()) %>%
  ungroup()

anova_result <- aov(SamplePhotoID ~ Temp_C * Light * Top_Bottom, data = count_data)
summary(anova_result)
```




