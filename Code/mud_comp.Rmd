---
title: "Mud Migration Community Compositon"
output: html_notebook
---
# Install packages if needed
```{r install_packages}
#install.packages("googlesheets4")
#install.packages("googledrive")
#install.packages("tidyverse")
```

# Load packages
```{r load_packages}
library(googlesheets4)
library(googledrive)
library(tidyverse)
```

# Connect to google account
Deauthorize google account to allow universal access to the raw data sheet.Then retrive data sheet from where it's stored on google drive.
```{r connect_google}
gs4_deauth()
googlesheet_url <- "https://docs.google.com/spreadsheets/d/1Ga0qnVxOVR9NwSNI5RM1iz1L2MoCAyF0O4x3D6mCePw/edit?gid=405129858#gid=405129858"
```

# Accessing sheets
```{r accessing_sheets}
community_composition <- read_sheet(googlesheet_url, sheet = "community_composition")
raw_cell_measurements <- read_sheet(googlesheet_url, sheet = "raw_cell_measurements")
data_dictionary <- read_sheet(googlesheet_url, sheet = "data_dictionary")
```
#### Please fix raw_cell_measurements_3 (order of chunks must work!) and rename all following 

# Set Up

## Set missing values of width_1 and width_2
```{r missing_widths}
corrected_width_data <- raw_cell_measurements |>
  mutate(Width1_um = case_when(
    is.na(Width1_um) ~ 1,
    TRUE ~ Width1_um
  ))

corrected_width_data <- corrected_width_data |>
  mutate(Width2_um = case_when(is.na(Width2_um) ~ Width1_um,
                               !is.na(Width2_um) ~ Width2_um
  ))
```

## List of morphotypes obseved 
```{r unqiue_morphotypes}
unique_morphotypes <- unique(corrected_width_data$CellMorphotype)
print(unique_morphotypes)
```

## Correct mispelled pennate
```{r correct_mispelling}
#Find cell containing the misspelled word
mislabel_pennate <- which(corrected_width_data  == "penate", arr.ind = TRUE)
mislabel_pennate

#Indicate the cell which was mislabeled
corrected_width_data[106, "CellMorphotype"] <- "pennate"
```

## Fix missing CellVol
```{r fix_missing_undefined}
#Rename morphotype to better calculate cell volume
corrected_width_data[12, "CellMorphotype"] <- "other"
```

## Estimate volumes & maximum linear dimension
```{r volumes_maxlinear}
#Calculate Cell Volume for each Morphotype
volume_dimension_data <- corrected_width_data |>
  mutate(CellVol = case_when(CellMorphotype == "centric" ~ pi * (Width1_um/2)^2 *  Width2_um,
                          CellMorphotype == "pennate" ~  Length_um * Width1_um * Width2_um,
                          CellMorphotype == "undefined" ~ 4/3 * pi * (Length_um/2)^3, 
                          CellMorphotype == "peanut" ~   Length_um * Width1_um * Width2_um,
                          CellMorphotype == "rectangular" ~ Length_um * Width1_um * Width2_um,
                          CellMorphotype == "square"~ Width1_um^2 * Width2_um, #check these values
                          CellMorphotype == "other" ~ 4/3 * pi * (Width1_um/2)^3
  )
  )

#Calculate Maximum Dimension
volume_dimension_data <- volume_dimension_data |>
  rowwise() |>
  mutate(MaxDim_um = max(Length_um, Width1_um, Width2_um, na.rm = TRUE)
  )
```

## Check for missing results
```{r missing_results}
#Find empty cells in CellVol
#empty_CellVol <- which(is.na(volume_dimension_data$CellVol))
#volume_dimension_data[empty_CellVol, ]

#Find it's location
#empty_CellVol_location <- cbind(row = empty_CellVol, column = "CellVol")
#empty_CellVol_location

#Find empty cells in MaxDim_um
#empty_MaxDim <- which(is.na(volume_dimension_data$MaxDim_um))
#volume_dimension_data[empty_MaxDim, ]

#Corrected these missing results, return to misspelling above ^
```

## Control for chain sizes
```{r size_chain}
volume_dimension_data <- volume_dimension_data %>%
  mutate(CellVol_Total = CellVol * ChainNum) %>%
  mutate(MaxDim_Total = MaxDim_um * ChainNum)
```

## Histogram of volumes and max dimension
```{r histogram}
#Plot Cell Volumes
volume_dimension_data |>
  ggplot()+
  geom_histogram(aes(CellVol_Total))

#Plot Maximum Dimensions
volume_dimension_data |>
  ggplot()+
  geom_histogram(aes(MaxDim_Total))
```

## Bin max dimension and cell volume
```{r bin_dimension}
#Maximum Cell Dimension 
bin_ranges_1 <- c(0, 5, 10, 20, 30, 40, 50, 75, 100, 150, 200)
volume_dimension_data <- volume_dimension_data |>
  dplyr::mutate(MaxDim_Bin = cut(MaxDim_Total, breaks = bin_ranges_1, include.lowest = TRUE, labels = c("0-5", "5-10", "10-20", "20-30", "30-40", "40-50", "50-75", "75-100", "100-150", "150-200")))

#Maximum Cell Volume
bin_ranges_2 <- c(0, 100, 1000, 5000, 10000, 15000, 20000, 25000, 100000)
volume_dimension_data <- volume_dimension_data |>
  dplyr::mutate(MaxVol_Bin = cut(CellVol_Total, breaks = bin_ranges_2, include.lowest = TRUE, labels = c("0-100", "100-1000", "1000-5000", "5000-10000", "10000-15000", "15000-20000", "20000-25000", "25000-100000")))
```

## Merge common value between raw data and conditions (light, temp, layer)
```{r merge_sheets}
merged_data <- merge(community_composition, volume_dimension_data, by = "SamplePhotoID", all.x = TRUE)
```

# Cell Count Analysis

## Create bargraph to visualize cell counts per sample
```{r bargraph_sample}
#Summarize data with chain number
merged_data_cell_count <- merged_data %>%
  group_by(Light, Temp_C, Top_Bottom, SamplePhotoID) %>%
  summarize(CellCount = sum(ChainNum), .groups = "drop")

#Create bar graph
ggplot(merged_data_cell_count, aes(x = SamplePhotoID, y = CellCount)) +
  geom_bar(stat = "identity", fill = "purple") +
  labs(x = "Sample", y = "Number of Cells", title = "Number of Cells per Sample") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Graph visualising cell count per condition
```{r graph_count_per_condition}
#New Code: Different count function, count using chain number 
ggplot(merged_data_cell_count, aes(x = Light, y = CellCount, fill = Light)) +
  geom_bar(stat = "identity") +
  labs(x = "Conditions (Light, Temp_C, Top_Bottom)", 
       y = "Cell Count per Image (NEED AREA)", 
       title = "Number of Cells per Condition") +
  facet_grid(rows = vars(Top_Bottom), cols = vars(Temp_C)) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),  
        axis.title.x = element_text(size = 12))  
```

# Cell Size Analysis

## Count number of observation in each maximum volume and dimension bin per condition
```{r bin_size_count}
 #Summarize the counts for each maximum dimension bin per condition
dimension_data <- merged_data |>
  dplyr::group_by(MaxDim_Bin, Light, Temp_C, Top_Bottom) |> 
  dplyr::summarize(MaxDim_Count = dplyr::n(), .groups = "drop") 

print(dimension_data)

#Summarize the counts for each cell volume bin per condition
volume_data <- merged_data |>
  dplyr::group_by(MaxVol_Bin, Light, Temp_C, Top_Bottom) |>
  dplyr::summarize(MaxVol_Count = dplyr::n(), .groups = "drop") 
  
print(volume_data)
```

## Plot number of observation in each maximum volume and dimension bin per condition
```{r graph_size_count_condition}
#Cell Count per Condition and Dimension
ggplot(dimension_data, aes(x = MaxDim_Bin, y = MaxDim_Count, fill = Light)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Maximum Dimension Bins (um)", 
       y = "Cell Count per Image (NEED AREA)", 
       title = "Cell Count per Condition and Dimension") +
  facet_grid(rows = vars(Top_Bottom), cols = vars(Temp_C)) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    axis.title.x = element_text(size = 12)           
  )

#Cell Count per Condition and Volume 
ggplot(volume_data, aes(x = MaxVol_Bin, y = MaxVol_Count, fill = Light)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Maximum Volume Bins (um3)", 
       y = "Cell Count per Image (NEED AREA)", 
       title = "Cell Count per Condition and Volume") +
  facet_grid(rows = vars(Top_Bottom), cols = vars(Temp_C)) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    axis.title.x = element_text(size = 12)           
  )
```

# New data set with morphotypes included for more specific analysis
```{r morphotype_size_count}
#Maximum dimension binned per condition and morphology
dimension_morphotype_data <- merged_data |>
  dplyr::group_by(MaxDim_Bin, Light, Temp_C, Top_Bottom, CellMorphotype) |> 
  dplyr::summarize(MaxDim_Count = dplyr::n(), .groups = "drop") |>

print(dimension_morphotype_data)

#Maximum volume binned per condition and morphology
volume_morphotype_data <- merged_data |>
  dplyr::group_by(MaxVol_Bin, Light, Temp_C, Top_Bottom, CellMorphotype) |> 
  dplyr::summarize(MaxVol_Count = dplyr::n(), .groups = "drop") |> 

print(volume_morphotype_data)

```

## Plot of pennate and centric volumes per condition
```{r pennate_centric_volume}
#Pennate diatoms ONLY
pennate_volume_data <- volume_morphotype_data %>%
  filter(CellMorphotype == "pennate")

ggplot(pennate_volume_data, aes(x = MaxVol_Bin, y = MaxVol_Count, fill = Light)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    x = "Maximum Volume Bins (um³)", 
    y = "Cell Count per Image (NEED AREA)", 
    title = "Cell Count per Condition and Maximum Volume (Pennate Only)"
  ) +
  facet_grid(rows = vars(Top_Bottom), cols = vars(Temp_C)) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    axis.title.x = element_text(size = 12)
  )

#Centric diatoms ONLY
centric_volume_data <- volume_morphotype_data %>%
  filter(CellMorphotype == "centric")

ggplot(centric_volume_data, aes(x = MaxVol_Bin, y = MaxVol_Count, fill = Light)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    x = "Maximum Volume Bins (um³)", 
    y = "Cell Count per Image (NEED AREA)", 
    title = "Cell Count per Condition and Maximum Volume (Centric Only)"
  ) +
  facet_grid(rows = vars(Top_Bottom), cols = vars(Temp_C)) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    axis.title.x = element_text(size = 12)
  )
```

## Plot of pennate and centric maximum dimension per condition
```{r pennate_centric_dimension}
#Pennate diatoms ONLY
pennate_dimension_data <- dimension_morphotype_data %>%
  filter(CellMorphotype == "pennate")

ggplot(pennate_dimension_data, aes(x = MaxDim_Bin, y = MaxDim_Count, fill = Light)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    x = "Maximum Dimension Bins (um)", 
    y = "Cell Count per Image (NEED AREA)", 
    title = "Cell Count per Condition and Maximum Dimension (Pennate Only)"
  ) +
  facet_grid(rows = vars(Top_Bottom), cols = vars(Temp_C)) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    axis.title.x = element_text(size = 12)
  )

#Centric diatoms ONLY
centric_dimension_data <- dimension_morphotype_data %>%
  filter(CellMorphotype == "centric")

ggplot(centric_dimension_data, aes(x = MaxDim_Bin, y = MaxDim_Count, fill = Light)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    x = "Maximum Volume Bins (um³)", 
    y = "Cell Count per Image (NEED AREA)", 
    title = "Cell Count per Condition and Maximum Dimension (Centric Only)"
  ) +
  facet_grid(rows = vars(Top_Bottom), cols = vars(Temp_C)) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    axis.title.x = element_text(size = 12)
  )
```


























