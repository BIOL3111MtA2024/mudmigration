---
title: "Mud Migration Community Compositon"
output: html_notebook
---
# Install packages if needed
```{r install_packages}
#install.packages("googlesheets4")
#install.packages("googledrive")
#install.packages("tidyverse")
```

# Load packages
```{r load_packages}
library(googlesheets4)
library(googledrive)
library(tidyverse)
```

# Connect to google account
Deauthorize google account to allow universal access to the raw data sheet.Then retrive data sheet from where it's stored on google drive.
```{r connect_google}
gs4_deauth()
googlesheet_url <- "https://docs.google.com/spreadsheets/d/1Ga0qnVxOVR9NwSNI5RM1iz1L2MoCAyF0O4x3D6mCePw/edit?gid=405129858#gid=405129858"
```

# Accessing sheets
```{r accessing_sheets}
community_composition <- read_sheet(googlesheet_url, sheet = "community_composition")
raw_cell_measurements <- read_sheet(googlesheet_url, sheet = "raw_cell_measurements")
data_dictionary <- read_sheet(googlesheet_url, sheet = "data_dictionary")
```
#### Please fix raw_cell_measurements_3 (order of chunks must work!) and rename all following 

# Set Up

## Set missing values of width_1 and width_2
```{r missing_widths}
raw_cell_measurements_2 <- raw_cell_measurements |>
  mutate(Width1_um = case_when(
    is.na(Width1_um) ~ 1,
    TRUE ~ Width1_um
  ))

raw_cell_measurements_3 <- raw_cell_measurements_2 |>
  mutate(Width2_um = case_when(is.na(Width2_um) ~ Width1_um,
                               !is.na(Width2_um) ~ Width2_um
  ))
```

## List of morphotypes obseved 
```{r unqiue_morphotypes}
unique_morphotypes <- unique(raw_cell_measurements_3$CellMorphotype)
print(unique_morphotypes)
```

## Correct mispelled pennate
```{r correct_mispelling}
#Find cell containing the misspelled word
mislabel_pennate <- which(raw_cell_measurements_3 == "penate", arr.ind = TRUE)
mislabel_pennate

#Indicate the cell which was mislabeled
raw_cell_measurements_3[106, "CellMorphotype"] <- "pennate"
```

## Fix missing CellVol
```{r fix_missing_undefined}
#Rename morphotype to better calculate cell volume
raw_cell_measurements_3[12, "CellMorphotype"] <- "other"
```

## Estimate volumes & maximum linear dimension
```{r volumes_maxlinear}
#Calculate Cell Volume for each Morphotype
raw_cell_measurements_4 <- raw_cell_measurements_3 |>
  mutate(CellVol = case_when(CellMorphotype == "centric" ~ pi * (Width1_um/2)^2 *  Width2_um,
                          CellMorphotype == "pennate" ~  Length_um * Width1_um * Width2_um,
                          CellMorphotype == "undefined" ~ 4/3 * pi * (Length_um/2)^3, 
                          CellMorphotype == "peanut" ~   Length_um * Width1_um * Width2_um,
                          CellMorphotype == "rectangular" ~ Length_um * Width1_um * Width2_um,
                          CellMorphotype == "square"~ Width1_um^2 * Width2_um, #check these values
                          CellMorphotype == "other" ~ 4/3 * pi * (Width1_um/2)^3
  )
  )

#Calculate Maximum Dimension
raw_cell_measurements_4 <- raw_cell_measurements_4 |>
  rowwise() |>
  mutate(MaxDim_um = max(Length_um, Width1_um, Width2_um, na.rm = TRUE)
  )
```

## Check for missing results
```{r missing_results}
#Find empty cells in CellVol
#empty_CellVol <- which(is.na(raw_cell_measurements_4$CellVol))
#raw_cell_measurements_4[empty_CellVol, ]

#Find it's location
#empty_CellVol_location <- cbind(row = empty_CellVol, column = "CellVol")
#empty_CellVol_location

#Find empty cells in MaxDim_um
#empty_MaxDim <- which(is.na(raw_cell_measurements_4$MaxDim_um))
#raw_cell_measurements_4[empty_MaxDim, ]

#Corrected these missing results, return to misspelling above ^
```

## Histogram of volumes and max dimension
```{r histogram}
#Plot Cell Volumes
raw_cell_measurements_4 |>
  ggplot()+
  geom_histogram(aes(CellVol))

#Plot Maximum Dimensions
raw_cell_measurements_4 |>
  ggplot()+
  geom_histogram(aes(MaxDim_um))
```

## Bin max dimension and cell volume
```{r bin_dimension}
#Maximum Cell Dimension 
bin_ranges_1 <- c(0, 5, 10, 20, 30, 40, 50, 75, 100, 150, 200)
raw_cell_measurements_4 <- raw_cell_measurements_4 |>
  dplyr::mutate(MaxDim_Bin = cut(MaxDim_um, breaks = bin_ranges_1, include.lowest = TRUE, labels = c("0-5", "5-10", "10-20", "20-30", "30-40", "40-50", "50-75", "75-100", "100-150", "150-200")))

#Maximum Cell Volume
bin_ranges_2 <- c(0, 100, 1000, 5000, 10000, 15000, 20000, 25000, 100000)
raw_cell_measurements_4 <- raw_cell_measurements_4 |>
  dplyr::mutate(MaxVol_Bin = cut(CellVol, breaks = bin_ranges_2, include.lowest = TRUE, labels = c("0-100", "100-1000", "1000-5000", "5000-10000", "10000-15000", "15000-20000", "20000-25000", "25000-100000")))
```

## Merge common value between raw data and conditions (light, temp, layer)
```{r merge_sheets}
merged_data <- merge(community_composition, raw_cell_measurements_4, by = "SamplePhotoID", all.x = TRUE)
```

# Cell Count Analysis

## Create bargraph to visualize cell counts per sample
```{r bargraph_sample}
# Count occurrences of each value
merged_data_cell_count <- merged_data %>%
  group_by(Light, Temp_C, Top_Bottom) %>%
  summarize(CellCount = sum(ChainNum), .groups = "drop")

# Create the bar graph
ggplot(CellCount, aes(x = SamplePhotoID, y = n)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(x = "Sample", y = "Number of Cells", title = "Number of Cells per Sample") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Graph visualising cell count per condition
```{r graph_count_per_condition}
#New Code: Different count function, count using chain number 
ggplot(expand_data_summary, aes(x = Light, y = CellCount, fill = Light)) +
  geom_bar(stat = "identity") +
  labs(x = "Conditions (Light, Temp_C, Top_Bottom)", 
       y = "Cell Count per Image (NEED AREA)", 
       title = "Number of Cells per Condition") +
  facet_grid(rows = vars(Top_Bottom), cols = vars(Temp_C)) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),  
        axis.title.x = element_text(size = 12))  
```

## Bargraph using associated data
```{r bargraph_associated}
#Fill is Light
ggplot(expand_data, aes(x = Light, y = SamplePhotoID, fill = Light)) +
  geom_bar(stat = "identity") +
  labs(x = "Condition (Light, Temp_C, Top_Bottom)", y = "Cell Count", title = "Number of Cells per Condition") +
  facet_grid(rows = vars(Top_Bottom), cols = vars(Temp_C)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Fill is Top or Bottom
ggplot(expand_data, aes(x = interaction(Light, Temp_C, Top_Bottom), y = SamplePhotoID, fill = Top_Bottom)) +
  geom_bar(stat = "identity") +
  labs(x = "Condition (Light, Temp_C, Top_Bottom)", y = "Cell Count", title = "Number of Cells per Condition") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_fill_manual(values = c("bottom" = "pink", "top" = "orange"))

#Fill is Temperature
ggplot(expand_data, aes(x = interaction(Light, Temp_C, Top_Bottom), y = SamplePhotoID, fill = factor(Temp_C))) +
  geom_bar(stat = "identity") +
  labs(x = "Condition (Light, Temp_C, Top_Bottom)", y = "Cell Count", title = "Number of Cells per Condition") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_fill_manual(values = c("15" = "red", "20" = "purple"))
```
#### EXPANDED DATA IS NO LONGER IN USE, BELOW MUST BE UPDATED WITH THIS CHANGE!



# Cell Size Analysis

## Count number of observation in each maximum volume and dimension bin per condition
```{r bin_count}
 #Summarize the counts for each maximum dimension bin and light level
dimension_data <- expand_data |>
  dplyr::group_by(MaxDim_Bin, Light, Temp_C, Top_Bottom) |> 
  dplyr::summarize(MaxDim_Count = dplyr::n(), .groups = "drop") |> 
  ungroup() |>
  group_by(Light, Temp_C, Top_Bottom) |> 
  dplyr::summarize(Treat_Count = dplyr::n(), .groups = "drop")
                   #MaxDim_Frac = MaxDim_Count/5)
print(dimension_data)

#Summarize the counts for each cell volume bin and light level
volume_count <- expand_data |>
  dplyr::group_by(MaxVol_Bin, Light, Temp_C, Top_Bottom) |>
  dplyr::summarize(Count = dplyr::n(), .groups = "drop")  
  
print(volume_count)
```

## Light: Plot number of observation in each maximum volume and dimension bin
```{r light_plot_bin_count}
#Bar graph of maximum dimension
ggplot(dimension_data, aes(x = MaxDim_Bin, y = Count, fill = Light)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Maximum Dimension Distribution by Light Level",
       x = "Maximum Dimension Bin (µm3)",
       y = "Number of Observations") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Bar graph of maximum volume
ggplot(volume_count, aes(x = MaxVol_Bin, y = Count, fill = Light)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Cell Volume Distribution by Light Level",
       x = "Cell Volume (µm3)",
       y = "Number of Observations") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Temperature: Plot number of observation in each maximum volume and dimension bin
```{r temperature_plot_bin_count}
#Bar graph of maximum dimension
ggplot(dimension_data, aes(x = MaxDim_Bin, y = Count, fill = factor(Temp_C))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Maximum Dimension Distribution by Temperature Level",
       x = "Maximum Dimension Bin (µm3)",
       y = "Number of Observations",
       fill = "Temperature (°C)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("15" = "red", "20" = "purple"))

#Bar graph of maximum volume
ggplot(volume_count, aes(x = MaxVol_Bin, y = Count, fill = factor(Temp_C))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Cell Volume Distribution by Temperature Level",
       x = "Cell Volume (µm3)",
       y = "Number of Observations") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_fill_manual(values = c("15" = "red", "20" = "purple"))
```

## Layer: Plot number of observation in each maximum volume and dimension bin
```{r layer_plot_bin_count}
#Bar graph of maximum dimension
ggplot(dimension_data, aes(x = MaxDim_Bin, y = Count, fill = Top_Bottom)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Maximum Dimension Distribution by Layer",
       x = "Maximum Dimension Bin (µm3)",
       y = "Number of Observations") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_fill_manual(values = c("bottom" = "pink", "top" = "orange"))

#Bar graph of maximum volume
ggplot(volume_count, aes(x = MaxVol_Bin, y = Count, fill = Top_Bottom)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Cell Volume Distribution by Layer",
       x = "Cell Volume (µm3)",
       y = "Number of Observations") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_fill_manual(values = c("bottom" = "pink", "top" = "orange"))
```



### Ask about which ANOVA to use..

## ANOVA on cell size observed under different temperatures and light levels
```{r anova_cell_size}
#One-way ANOVA for Count ~ MaxDim_Bin
anova_result_2 <- aov(Count ~ MaxDim_Bin, data = dimension_data)
summary(anova_result_2)

#Factorial ANOVA with interactions for light and temperature for MaxDim_Bin
anova_result_3 <- aov(Count ~ MaxDim_Bin * Light * Temp_C, data = dimension_data)
summary(anova_result_3)
#What about layer????????

#One-way ANOVA for Count ~ MaxVol_Bin
anova_result_4 <- aov(Count ~ MaxVol_Bin, data = volume_count)
summary(anova_result_4)

#Factorial ANOVA with interactions for light and temperature for MaxVol_Bin
anova_result_5 <- aov(Count ~ MaxVol_Bin * Light * Temp_C, data = volume_count)
summary(anova_result_5)
#What about layer????????
```

## ANOVA on cell size observed at each layer
```{r anova_size_layer}
#ANOVA for Count ~ Top_Bottom
anova_result_6 <- aov(Count ~ MaxDim_Bin * Top_Bottom, data = dimension_data)
summary(anova_result_6)
```

## PostHoc testing due to significance in MaxDim_Bin and MaxVol_Bin
```{r tukey}
#PostHoc for Count ~ MaxDim_Bin with temperature and light
tukey_result <- TukeyHSD(anova_result_2)
print(tukey_result)

#PostHoc for Count ~ MaxVol_Bin with temperature and light
tukey_result_2 <- TukeyHSD(anova_result_4)
print(tukey_result_2)
```

## ANOVA on cell size focusing on the interaction between size and layer
```{r anova_focused}
#ANOVA on MaxDim_Bin and layer 
anova_result_7 <- aov(Count ~ MaxDim_Bin * Light * Temp_C + MaxDim_Bin:Top_Bottom, data = dimension_data)
summary(anova_result_7)

#ANOVA on MaxVol_Bin and layer
anova_result_8 <- aov(Count ~ MaxVol_Bin * Light * Temp_C + MaxVol_Bin:Top_Bottom, data = volume_count)
summary(anova_result_8)
```









